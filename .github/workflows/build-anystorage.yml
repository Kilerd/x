name: Build AnyStorage Release

on:
  # API è§¦å‘ï¼ˆä¿ç•™åŸæœ‰æ–¹å¼ï¼‰
  repository_dispatch:
    types: [build-anystorage-release]

  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ–°å¢ï¼‰
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.0.1-beta.7)'
        required: true
        type: string
      tag:
        description: 'Git tag name (e.g., v0.0.1-beta.7)'
        required: true
        type: string
      is_prerelease:
        description: 'Is this a prerelease?'
        required: true
        type: boolean
        default: true
      ref:
        description: 'Git ref to checkout (leave empty to use tag)'
        required: false
        type: string
      sha:
        description: 'Commit SHA (optional, for tracking)'
        required: false
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      tag: ${{ steps.extract.outputs.tag }}
      is_prerelease: ${{ steps.extract.outputs.is_prerelease }}
      ref: ${{ steps.extract.outputs.ref }}
      sha: ${{ steps.extract.outputs.sha }}
      is_beta: ${{ steps.extract.outputs.is_beta }}
    steps:
      - name: Extract payload data
        id: extract
        run: |
          # åˆ¤æ–­è§¦å‘æ–¹å¼å¹¶æå–å‚æ•°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨ inputs
            VERSION="${{ github.event.inputs.version }}"
            TAG="${{ github.event.inputs.tag }}"
            IS_PRERELEASE="${{ github.event.inputs.is_prerelease }}"
            REF="${{ github.event.inputs.ref }}"
            SHA="${{ github.event.inputs.sha }}"

            # å¦‚æœ ref ä¸ºç©ºï¼Œä½¿ç”¨ tag ä½œä¸º ref
            if [ -z "$REF" ]; then
              REF="$TAG"
            fi

            # å¦‚æœ sha ä¸ºç©ºï¼Œè®¾ç½®ä¸º N/A
            if [ -z "$SHA" ]; then
              SHA="N/A"
            fi

            echo "ğŸ–±ï¸  Manual workflow trigger"
          else
            # API è§¦å‘ï¼šä½¿ç”¨ client_payload
            VERSION="${{ github.event.client_payload.version }}"
            TAG="${{ github.event.client_payload.tag }}"
            IS_PRERELEASE="${{ github.event.client_payload.is_prerelease }}"
            REF="${{ github.event.client_payload.ref }}"
            SHA="${{ github.event.client_payload.sha }}"

            echo "ğŸ”— Repository dispatch trigger"
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸º beta ç‰ˆæœ¬
          if [[ "$VERSION" == *"beta"* ]]; then
            IS_BETA="true"
            echo "âš ï¸  Beta version detected - Windows build will be skipped"
          else
            IS_BETA="false"
          fi

          # è¾“å‡ºåˆ° GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "is_beta=$IS_BETA" >> $GITHUB_OUTPUT

          # æ˜¾ç¤ºæ„å»ºä¿¡æ¯
          echo "ğŸ“¦ Building AnyStorage Tauri $VERSION"
          echo "ğŸ·ï¸  Tag: $TAG"
          echo "ğŸ”– Prerelease: $IS_PRERELEASE"
          echo "ğŸ”– Beta: $IS_BETA"
          echo "ğŸ“ Ref: $REF"
          echo "ğŸ“ SHA: $SHA"

  build:
    needs: prepare
    runs-on: ${{ matrix.platform }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Apple Silicon
          - platform: 'macos-latest'
            os_label: 'mac'
            arch: 'aarch64'
            target: 'aarch64-apple-darwin'
            skip_on_beta: false
          # macOS Intel
          - platform: 'macos-15-intel'
            os_label: 'mac'
            arch: 'x86_64'
            target: 'x86_64-apple-darwin'
            skip_on_beta: false
          # Windows x64
          - platform: 'windows-latest'
            os_label: 'win'
            arch: 'x86_64'
            target: 'x86_64-pc-windows-msvc'
            skip_on_beta: true
          # Linux x64
          - platform: 'ubuntu-22.04'
            os_label: 'linux'
            arch: 'x86_64'
            target: 'x86_64-unknown-linux-gnu'
            skip_on_beta: false

    steps:
      - name: Check if build should be skipped
        id: should_skip
        shell: bash
        run: |
          if [[ "${{ matrix.skip_on_beta }}" == "true" && "${{ needs.prepare.outputs.is_beta }}" == "true" ]]; then
            echo "âš ï¸  Skipping Windows build for beta version"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout private repository
        if: steps.should_skip.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: kilerd/anystorage-tauri
          ref: ${{ needs.prepare.outputs.ref }}
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}

      - name: Setup Node.js
        if: steps.should_skip.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        if: steps.should_skip.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        if: steps.should_skip.outputs.skip != 'true'
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      - name: Install Linux dependencies
        if: steps.should_skip.outputs.skip != 'true' && runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev

      # åœ¨æ„å»ºå‰è‡ªåŠ¨å°† tag ç‰ˆæœ¬å·å†™å…¥ tauri.conf.json
      # å¼€å‘ç¯å¢ƒä¿æŒ 0.1.0ï¼Œå‘ç‰ˆæ—¶åŠ¨æ€è®¾ç½®æ­£ç¡®ç‰ˆæœ¬
      - name: Install jq (Windows only)
        if: steps.should_skip.outputs.skip != 'true' && runner.os == 'Windows'
        shell: pwsh
        run: choco install jq -y

      - name: Update version in tauri.conf.json
        if: steps.should_skip.outputs.skip != 'true'
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          echo "ğŸ“ Updating Tauri version to $VERSION"

          # Update tauri.conf.json
          jq --arg version "$VERSION" '.version = $version' src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp
          mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json

          echo "âœ… Updated version to $VERSION in src-tauri/tauri.conf.json"

      - name: Verify version update
        if: steps.should_skip.outputs.skip != 'true'
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          if [[ "$RUNNER_OS" == "Windows" ]]; then
            # Windows: ä½¿ç”¨ PowerShell è¯»å– JSON
            TAURI_VERSION=$(powershell -Command "(Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json).version")
          else
            # macOS/Linux: ä½¿ç”¨ jq
            TAURI_VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          fi

          echo "ğŸ“‹ Version check:"
          echo "   Expected:                  $VERSION"
          echo "   src-tauri/tauri.conf.json: $TAURI_VERSION"

          if [ "$TAURI_VERSION" != "$VERSION" ]; then
            echo "âŒ Version update failed! Tauri version does not match."
            exit 1
          fi

          echo "âœ… Version verification passed"

      - name: Install frontend dependencies
        if: steps.should_skip.outputs.skip != 'true'
        run: npm install

      # macOS ä»£ç ç­¾åï¼šå¯¼å…¥è¯ä¹¦åˆ°é’¥åŒ™é“¾
      - name: Import Apple Developer Certificate
        if: steps.should_skip.outputs.skip != 'true' && runner.os == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.CSC_LINK }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "ğŸ” Importing Apple Developer Certificate..."

          # è§£ç è¯ä¹¦
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12

          # åˆ›å»ºä¸´æ—¶é’¥åŒ™é“¾
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # å¯¼å…¥è¯ä¹¦
          security import certificate.p12 -k build.keychain \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          # å…è®¸ codesign ä½¿ç”¨è¯ä¹¦
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # æ¸…ç†è¯ä¹¦æ–‡ä»¶
          rm certificate.p12

          echo "âœ… Certificate imported successfully"

      # macOS ä»£ç ç­¾åï¼šæå–è¯ä¹¦ Identity
      - name: Extract Certificate Identity
        if: steps.should_skip.outputs.skip != 'true' && runner.os == 'macOS'
        run: |
          # ä»é’¥åŒ™é“¾ä¸­æŸ¥æ‰¾è¯ä¹¦å®Œæ•´åç§°ï¼ˆè€Œä¸æ˜¯ SHA-1 å“ˆå¸Œï¼‰
          CERT_NAME=$(security find-identity -v -p codesigning build.keychain | \
            grep "Developer ID Application" | \
            head -1 | \
            sed -n 's/.*"\(.*\)"/\1/p')

          if [ -z "$CERT_NAME" ]; then
            echo "âŒ Failed to extract certificate identity"
            security find-identity -v -p codesigning build.keychain
            exit 1
          fi

          echo "APPLE_SIGNING_IDENTITY=$CERT_NAME" >> $GITHUB_ENV
          echo "âœ… Certificate Identity: $CERT_NAME"

      - name: Build Tauri application
        if: steps.should_skip.outputs.skip != 'true'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Tauri updater ç­¾å
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # macOS ä»£ç ç­¾åå’Œå…¬è¯
          APPLE_CERTIFICATE: ${{ secrets.CSC_LINK }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          projectPath: '.'
          args: '--target ${{ matrix.target }}'
          # ä¸ç›´æ¥å‘å¸ƒåˆ° releaseï¼Œåªç”Ÿæˆæ„å»ºäº§ç‰©
          tagName: ''
          releaseName: ''
          releaseBody: ''
          releaseDraft: true
          # Updater é…ç½®
          includeUpdaterJson: false
          updaterJsonKeepUniversal: false

      - name: Upload artifacts
        if: steps.should_skip.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os_label }}-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.app.tar.gz
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.app.tar.gz.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.exe
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.exe.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.deb.sig
          retention-days: 7
          if-no-files-found: error

  generate-updater-json:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    outputs:
      updater_json: ${{ steps.generate.outputs.json }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate Updater JSON
        id: generate
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          NOTES="Release $VERSION"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          IS_BETA="${{ needs.prepare.outputs.is_beta }}"

          echo "ğŸ“¦ Generating updater JSON for version $VERSION"

          # åˆå§‹åŒ– JSON
          cat > latest.json << 'JSONEOF'
          {
            "version": "VERSION_PLACEHOLDER",
            "notes": "NOTES_PLACEHOLDER",
            "pub_date": "DATE_PLACEHOLDER",
            "platforms": {}
          }
          JSONEOF

          # æ›¿æ¢å ä½ç¬¦
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" latest.json
          sed -i "s/NOTES_PLACEHOLDER/$NOTES/g" latest.json
          sed -i "s/DATE_PLACEHOLDER/$PUB_DATE/g" latest.json

          # å¤„ç†æ¯ä¸ªå¹³å°
          process_platform() {
            local os=$1
            local arch=$2
            local platform_key="darwin"
            if [ "$os" = "win" ]; then
              platform_key="windows"
            elif [ "$os" = "linux" ]; then
              platform_key="linux"
            fi
            local platform="${platform_key}-${arch}"
            local artifact_dir="artifacts/release-${os}-${arch}"

            echo "ğŸ” Processing platform: $platform (artifact_dir: $artifact_dir)"

            if [ ! -d "$artifact_dir" ]; then
              echo "âš ï¸  Artifact directory not found: $artifact_dir"
              return
            fi

            # æŸ¥æ‰¾å®‰è£…åŒ…å’Œç­¾å
            INSTALLER=""
            if [ "$os" = "mac" ]; then
              INSTALLER=$(find "$artifact_dir" -name "*.app.tar.gz" -not -name "*.sig" 2>/dev/null | head -1)
            elif [ "$os" = "win" ]; then
              INSTALLER=$(find "$artifact_dir" -name "*.msi" -o -name "*-setup.exe" 2>/dev/null | grep -v "\.sig$" | head -1)
            elif [ "$os" = "linux" ]; then
              INSTALLER=$(find "$artifact_dir" -name "*.AppImage" 2>/dev/null | grep -v "\.sig$" | head -1)
            fi

            if [ -z "$INSTALLER" ]; then
              echo "âš ï¸  No installer found for $platform"
              ls -la "$artifact_dir" || true
              return
            fi

            echo "âœ… Found installer: $INSTALLER"

            SIG_FILE="${INSTALLER}.sig"

            if [ ! -f "$SIG_FILE" ]; then
              echo "âŒ Signature file not found: $SIG_FILE"
              return
            fi

            # è¯»å–ç­¾åå†…å®¹
            SIGNATURE=$(cat "$SIG_FILE")
            FILENAME=$(basename "$INSTALLER")
            DOWNLOAD_URL="https://github.com/kilerd/anystorage-release/releases/download/${{ needs.prepare.outputs.tag }}/${FILENAME}"

            echo "ğŸ“ Adding platform $platform with file $FILENAME"

            # ä½¿ç”¨ jq æ·»åŠ å¹³å°ä¿¡æ¯
            jq --arg platform "$platform" \
               --arg url "$DOWNLOAD_URL" \
               --arg sig "$SIGNATURE" \
               '.platforms[$platform] = {"signature": $sig, "url": $url}' \
               latest.json > latest.json.tmp
            mv latest.json.tmp latest.json

            echo "âœ… Added $platform to updater JSON"
          }

          # å¤„ç†æ‰€æœ‰å¹³å°
          process_platform "mac" "aarch64"
          process_platform "mac" "x86_64"
          process_platform "linux" "x86_64"

          # Windows ä»…åœ¨é beta æ—¶å¤„ç†
          if [ "$IS_BETA" != "true" ]; then
            process_platform "win" "x86_64"
          fi

          # è¾“å‡ºæœ€ç»ˆ JSON
          echo "ğŸ“„ Generated updater JSON:"
          cat latest.json

      - name: Upload updater JSON as artifact
        uses: actions/upload-artifact@v4
        with:
          name: updater-json
          path: latest.json
          retention-days: 7

  release:
    needs: [prepare, build, generate-updater-json]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Prepare release body
        id: release_body
        run: |
          IS_BETA="${{ needs.prepare.outputs.is_beta }}"

          if [ "$IS_BETA" == "true" ]; then
            BODY="# AnyStorage ${{ needs.prepare.outputs.version }}

            Release artifacts for AnyStorage (Tauri).

            **Platforms:**
            - macOS Apple Silicon (ARM64)
            - macOS Intel (x86_64)
            - Linux x64 (AppImage, Deb)

            âš ï¸ **Note:** Windows build is not available for beta versions.

            ## Auto Update

            This release includes \`latest.json\` for Tauri auto-updater support. Installed apps will automatically detect and download updates.

            ## Download

            Download the appropriate installer for your platform below.

            For more information, visit the [main repository](https://github.com/Kilerd/anystorage-release)."
          else
            BODY="# AnyStorage ${{ needs.prepare.outputs.version }}

            Release artifacts for AnyStorage (Tauri).

            **Platforms:**
            - macOS Apple Silicon (ARM64)
            - macOS Intel (x86_64)
            - Windows x64
            - Linux x64 (AppImage, Deb)

            ## Auto Update

            This release includes \`latest.json\` for Tauri auto-updater support. Installed apps will automatically detect and download updates.

            ## Download

            Download the appropriate installer for your platform below.

            For more information, visit the [main repository](https://github.com/Kilerd/anystorage-release)."
          fi

          # ä½¿ç”¨å¤šè¡Œè¾“å‡º
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Collect artifacts (non-beta)
        if: needs.prepare.outputs.is_beta != 'true'
        run: |
          mkdir -p release-files

          echo "ğŸ“¦ Collecting artifacts for all platforms..."

          # macOS ARM64
          find artifacts/release-mac-aarch64/ -type f \( -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.sig" \) -exec cp {} release-files/ \; 2>/dev/null || true

          # macOS Intel
          find artifacts/release-mac-x86_64/ -type f \( -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.sig" \) -exec cp {} release-files/ \; 2>/dev/null || true

          # Windows
          find artifacts/release-win-x86_64/ -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.sig" \) -exec cp {} release-files/ \; 2>/dev/null || true

          # Linux
          find artifacts/release-linux-x86_64/ -type f \( -name "*.AppImage" -o -name "*.deb" -o -name "*.sig" \) -exec cp {} release-files/ \; 2>/dev/null || true

          # Updater JSON
          cp artifacts/updater-json/latest.json release-files/ 2>/dev/null || echo "âš ï¸  latest.json not found"

          echo "âœ… Collected files:"
          ls -lh release-files/

      - name: Collect artifacts (beta - no Windows)
        if: needs.prepare.outputs.is_beta == 'true'
        run: |
          mkdir -p release-files

          echo "ğŸ“¦ Collecting artifacts for beta (no Windows)..."

          # macOS ARM64
          find artifacts/release-mac-aarch64/ -type f \( -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.sig" \) -exec cp {} release-files/ \; 2>/dev/null || true

          # macOS Intel
          find artifacts/release-mac-x86_64/ -type f \( -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.sig" \) -exec cp {} release-files/ \; 2>/dev/null || true

          # Linux
          find artifacts/release-linux-x86_64/ -type f \( -name "*.AppImage" -o -name "*.deb" -o -name "*.sig" \) -exec cp {} release-files/ \; 2>/dev/null || true

          # Updater JSON
          cp artifacts/updater-json/latest.json release-files/ 2>/dev/null || echo "âš ï¸  latest.json not found"

          echo "âœ… Collected files:"
          ls -lh release-files/

      - name: Create GitHub Release in anystorage-release repository
        uses: softprops/action-gh-release@v2
        with:
          name: AnyStorage ${{ needs.prepare.outputs.version }}
          tag_name: ${{ needs.prepare.outputs.tag }}
          repository: kilerd/anystorage-release
          token: ${{ secrets.RELEASE_REPO_TOKEN }}
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          draft: false
          generate_release_notes: false
          body: ${{ steps.release_body.outputs.body }}
          files: release-files/*
          fail_on_unmatched_files: true

      - name: Release complete
        run: |
          echo "âœ… Release ${{ needs.prepare.outputs.tag }} published to anystorage-release repository"
          echo "ğŸ”— https://github.com/kilerd/anystorage-release/releases/tag/${{ needs.prepare.outputs.tag }}"
          if [ "${{ needs.prepare.outputs.is_beta }}" == "true" ]; then
            echo "âš ï¸  Beta version: Windows build was skipped"
          fi
